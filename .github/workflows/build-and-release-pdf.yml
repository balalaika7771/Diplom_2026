name: Build and release PDF

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install TeX Live and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-lang-cyrillic \
            texlive-bibtex-extra \
            texlive-fonts-extra \
            texlive-science \
            texlive-pictures \
            texlive-luatex \
            texlive-extra-utils \
            texlive-font-utils \
            biber \
            make \
            pandoc \
            python3 \
            python3-pip \
            unzip \
            libreoffice \
            lua5.3
          
          # latexpand должен быть доступен через texlive-extra-utils
          # Проверяем наличие latexpand
          if ! command -v latexpand &> /dev/null; then
            echo "latexpand не найден, будет использован альтернативный метод объединения файлов"
          fi

      - name: Generate chapter lists and build PDF
        run: |
          make

      - name: Convert LaTeX to Word document
        run: |
          cd build
          
          # Функция для проверки валидности DOCX файла
          check_docx_valid() {
            local docx_file="$1"
            if [ ! -f "$docx_file" ] || [ ! -s "$docx_file" ]; then
              return 1
            fi
            
            # Проверяем размер (должен быть больше 10KB)
            local FILE_SIZE=$(stat -f%z "$docx_file" 2>/dev/null || stat -c%s "$docx_file" 2>/dev/null || echo "0")
            if [ "$FILE_SIZE" -lt 10000 ]; then
              return 1
            fi
            
            # Проверяем, что это валидный ZIP архив (DOCX это ZIP)
            if ! unzip -t -q "$docx_file" 2>/dev/null; then
              return 1
            fi
            
            # Проверяем наличие обязательных файлов в DOCX
            if ! unzip -l "$docx_file" 2>/dev/null | grep -q "word/document.xml"; then
              return 1
            fi
            
            return 0
          }
          
          CONVERSION_SUCCESS=false
          
          # Метод 1: PDF -> DOCX через LibreOffice (самый надежный, так как PDF уже собран)
          echo "=== Метод 1: Конвертация PDF -> DOCX через LibreOffice ==="
          if [ -f main.pdf ]; then
            PDF_SIZE=$(stat -f%z main.pdf 2>/dev/null || stat -c%s main.pdf 2>/dev/null || echo "0")
            echo "PDF размер: $PDF_SIZE байт"
            
            if [ "$PDF_SIZE" -gt 10000 ]; then
              echo "Конвертация PDF в DOCX через LibreOffice..."
              # Используем более надежные опции для LibreOffice
              libreoffice --headless \
                --nodefault \
                --nolockcheck \
                --nologo \
                --norestore \
                --convert-to docx:"MS Word 2007 XML" \
                --outdir . \
                main.pdf 2>&1 | tee libreoffice.log
              
              if check_docx_valid main.docx; then
                FILE_SIZE=$(stat -f%z main.docx 2>/dev/null || stat -c%s main.docx 2>/dev/null || echo "0")
                echo "✓ PDF успешно конвертирован в DOCX (размер: $FILE_SIZE байт)"
                CONVERSION_SUCCESS=true
              else
                echo "⚠ DOCX файл невалиден или поврежден, пробуем другой метод..."
                rm -f main.docx
              fi
            else
              echo "⚠ PDF файл слишком маленький, пропускаем конвертацию"
            fi
          else
            echo "⚠ PDF файл не найден"
          fi
          
          # Метод 2: LaTeX -> DOCX через pandoc (если PDF метод не сработал)
          if [ "$CONVERSION_SUCCESS" = false ]; then
            echo ""
            echo "=== Метод 2: Конвертация LaTeX -> DOCX через pandoc ==="
            
            # Объединяем LaTeX файлы
            if command -v latexpand &> /dev/null; then
              echo "Объединение LaTeX файлов через latexpand..."
              if [ -f main.bbl ]; then
                latexpand --expand-bbl main.bbl main.tex > main_expanded.tex 2>&1 || \
                latexpand main.tex > main_expanded.tex 2>&1
              else
                latexpand main.tex > main_expanded.tex 2>&1
              fi
              
              if [ -s main_expanded.tex ]; then
                echo "✓ Файлы объединены ($(wc -l < main_expanded.tex) строк)"
                TEX_FILE="main_expanded.tex"
              else
                echo "⚠ latexpand не сработал, используем исходный main.tex"
                TEX_FILE="main.tex"
              fi
            else
              echo "latexpand не найден, используем исходный main.tex"
              TEX_FILE="main.tex"
            fi
            
            # Конвертируем через pandoc
            echo "Конвертация через pandoc..."
            pandoc "$TEX_FILE" \
              --from=latex \
              --to=docx \
              --output=main.docx \
              --standalone \
              --wrap=none \
              2>&1 | tee pandoc.log
            
            if check_docx_valid main.docx; then
              FILE_SIZE=$(stat -f%z main.docx 2>/dev/null || stat -c%s main.docx 2>/dev/null || echo "0")
              echo "✓ Pandoc успешно создал DOCX (размер: $FILE_SIZE байт)"
              CONVERSION_SUCCESS=true
            else
              echo "⚠ Pandoc создал невалидный DOCX, пробуем другой метод..."
              rm -f main.docx
            fi
          fi
          
          # Метод 3: LaTeX -> ODT -> DOCX через LibreOffice
          if [ "$CONVERSION_SUCCESS" = false ]; then
            echo ""
            echo "=== Метод 3: Конвертация LaTeX -> ODT -> DOCX ==="
            
            if [ -z "$TEX_FILE" ]; then
              if [ -f main_expanded.tex ]; then
                TEX_FILE="main_expanded.tex"
              else
                TEX_FILE="main.tex"
              fi
            fi
            
            echo "Конвертация LaTeX в ODT через htlatex..."
            htlatex "$TEX_FILE" "odt" "" "" "-interaction=nonstopmode" 2>&1 | tail -30
            
            if [ -f "${TEX_FILE%.tex}.odt" ]; then
              ODT_FILE="${TEX_FILE%.tex}.odt"
            elif [ -f main_expanded.odt ]; then
              ODT_FILE="main_expanded.odt"
            else
              ODT_FILE=""
            fi
            
            if [ -n "$ODT_FILE" ] && [ -f "$ODT_FILE" ]; then
              echo "Конвертация ODT в DOCX через LibreOffice..."
              libreoffice --headless \
                --nodefault \
                --nolockcheck \
                --nologo \
                --norestore \
                --convert-to docx:"MS Word 2007 XML" \
                --outdir . \
                "$ODT_FILE" 2>&1 | tee -a libreoffice.log
              
              if [ -f "${ODT_FILE%.odt}.docx" ]; then
                mv "${ODT_FILE%.odt}.docx" main.docx
              fi
              
              if check_docx_valid main.docx; then
                FILE_SIZE=$(stat -f%z main.docx 2>/dev/null || stat -c%s main.docx 2>/dev/null || echo "0")
                echo "✓ ODT успешно конвертирован в DOCX (размер: $FILE_SIZE байт)"
                CONVERSION_SUCCESS=true
              fi
            fi
          fi
          
          # Финальная проверка
          echo ""
          if [ "$CONVERSION_SUCCESS" = false ] || ! check_docx_valid main.docx; then
            echo "❌ Ошибка: Не удалось создать валидный Word документ"
            echo "Размер файла: $(ls -lh main.docx 2>/dev/null || echo 'файл не существует')"
            if [ -f pandoc.log ]; then
              echo "Последние строки лога pandoc:"
              tail -30 pandoc.log
            fi
            if [ -f libreoffice.log ]; then
              echo "Последние строки лога LibreOffice:"
              tail -30 libreoffice.log
            fi
            exit 1
          fi
          
          FILE_SIZE=$(stat -f%z main.docx 2>/dev/null || stat -c%s main.docx 2>/dev/null || echo "0")
          echo "✓ Word документ создан успешно и валиден (размер: $FILE_SIZE байт)"
          ls -lh main.docx

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: dissertation-pdf
          path: build/main.pdf

      - name: Upload Word artifact
        uses: actions/upload-artifact@v4
        with:
          name: dissertation-word
          path: build/main.docx
        continue-on-error: true

      - name: Create GitHub Release with PDF and Word
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: pdf-${{ github.run_id }}-${{ github.run_number }}
          name: PDF build ${{ github.run_id }}-${{ github.run_number }}
          draft: false
          prerelease: true
          files: |
            build/main.pdf
            build/main.docx

      - name: Upload to Yandex Disk
        if: github.ref == 'refs/heads/main'
        env:
          YANDEX_DISK_TOKEN: ${{ secrets.YANDEX_DISK_TOKEN }}
        run: |
          if [ -z "$YANDEX_DISK_TOKEN" ]; then
            echo "Предупреждение: YANDEX_DISK_TOKEN не установлен, пропускаем загрузку на Яндекс.Диск"
            exit 0
          fi
          
          TOKEN="$YANDEX_DISK_TOKEN"
          
          # Функция для URL-кодирования пути
          url_encode() {
            python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1], safe=''))" "$1"
          }
          
          # Функция для создания папки (если не существует)
          ensure_folder() {
            local FOLDER_PATH="$1"
            local ENCODED_PATH=$(url_encode "$FOLDER_PATH")
            
            echo "Проверка/создание папки: $FOLDER_PATH"
            
            # Сначала проверяем, существует ли папка
            CHECK_RESPONSE=$(curl -s -X GET \
              "https://cloud-api.yandex.net/v1/disk/resources?path=$ENCODED_PATH" \
              -H "Authorization: OAuth $TOKEN")
            
            if echo "$CHECK_RESPONSE" | grep -q '"type":"dir"'; then
              echo "Папка уже существует"
              return 0
            fi
            
            # Пытаемся создать папку
            RESPONSE=$(curl -s -X PUT \
              "https://cloud-api.yandex.net/v1/disk/resources?path=$ENCODED_PATH" \
              -H "Authorization: OAuth $TOKEN")
            
            # Проверяем результат
            if echo "$RESPONSE" | grep -q '"type":"dir"\|"created"\|"path"'; then
              echo "Папка создана успешно"
              return 0
            elif echo "$RESPONSE" | grep -q "already_exists\|DiskPathPointsToExistentDirectoryError"; then
              echo "Папка уже существует"
              return 0
            else
              echo "Предупреждение: не удалось создать папку, ответ API: $RESPONSE"
              # Продолжаем в любом случае
              return 0
            fi
          }
          
          # Функция для загрузки файла на Яндекс.Диск
          upload_file() {
            local FILE_PATH="$1"
            local DISK_PATH="$2"
            local FILENAME=$(basename "$FILE_PATH")
            
            echo "Загрузка $FILENAME на Яндекс.Диск в $DISK_PATH..."
            
            # URL-кодируем путь правильно
            ENCODED_PATH=$(url_encode "$DISK_PATH")
            
            # Получаем URL для загрузки
            RESPONSE=$(curl -s -X GET \
              "https://cloud-api.yandex.net/v1/disk/resources/upload?path=$ENCODED_PATH&overwrite=true" \
              -H "Authorization: OAuth $TOKEN")
            
            UPLOAD_URL=$(echo "$RESPONSE" | grep -o '"href":"[^"]*' | cut -d'"' -f4)
            
            if [ -z "$UPLOAD_URL" ]; then
              echo "Ошибка: не удалось получить URL для загрузки"
              echo "Ответ API: $RESPONSE"
              return 1
            fi
            
            # Загружаем файл
            HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null -X PUT "$UPLOAD_URL" \
              --upload-file "$FILE_PATH")
            
            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "202" ]; then
              echo "✓ Файл $FILENAME успешно загружен"
              return 0
            else
              echo "Ошибка загрузки $FILENAME: HTTP $HTTP_CODE"
              return 1
            fi
          }
          
          # Используем путь к папке "Диссертация"
          BASE_PATH="disk:/Диссертация"
          
          # Проверяем существование папки и создаем если нужно
          echo "Проверка/создание папки: $BASE_PATH"
          ENCODED_BASE=$(url_encode "$BASE_PATH")
          RESPONSE=$(curl -s -X GET \
            "https://cloud-api.yandex.net/v1/disk/resources?path=$ENCODED_BASE" \
            -H "Authorization: OAuth $TOKEN")
          
          if ! echo "$RESPONSE" | grep -q '"type":"dir"'; then
            echo "Папка не существует, создаем..."
            ensure_folder "$BASE_PATH"
          else
            echo "Папка существует"
          fi
          
          # Создаем подпапку с датой и временем для каждой сборки
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          # Убираем завершающий слеш из BASE_PATH если есть
          BASE_PATH_CLEAN="${BASE_PATH%/}"
          BUILD_FOLDER="${BASE_PATH_CLEAN}/build_${TIMESTAMP}"
          
          echo "Создание подпапки для сборки: $BUILD_FOLDER"
          # Создаем подпапку для сборки
          ensure_folder "$BUILD_FOLDER"
          
          # Загружаем PDF (мы находимся в корне репозитория)
          upload_file "build/main.pdf" "${BUILD_FOLDER}/main.pdf"
          
          # Загружаем Word (если создан)
          if [ -f "build/main.docx" ]; then
            upload_file "build/main.docx" "${BUILD_FOLDER}/main.docx"
          fi
          
          echo "Все файлы загружены в: $BUILD_FOLDER"
          echo "Просмотр: https://disk.yandex.ru/d/RRdCy4WNyrE3xA"


